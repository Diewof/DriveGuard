# Flujo de Datos - DriveGuard

Este documento detalla cรณmo fluyen los datos a travรฉs de las diferentes capas de la aplicaciรณn DriveGuard.

---

## ๐ Diagrama General de Flujo

```
โโโโโโโโโโโโโโโโโโโ
โ  ESP32-CAM      โ
โ  + Sensores     โ
โโโโโโโโโโฌโโโโโโโโโ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโ
โ HTTP Server     โ
โ (Puerto 8080)   โ
โโโโโโโโโโฌโโโโโโโโโ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ         PRESENTATION LAYER              โ
โ  โโโโโโโโโโโโโโโโ   โโโโโโโโโโโโโโโโโโ โ
โ  โ CameraBloc   โ   โ DashboardBloc  โ โ
โ  โโโโโโโโฌโโโโโโโโ   โโโโโโโโโโฌโโโโโโโโ โ
โ         โ                    โ         โ
โ         โผ                    โผ         โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ         UI Widgets               โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ                    โ
         โผ                    โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ           DOMAIN LAYER                  โ
โ  โโโโโโโโโโโโโโโโ   โโโโโโโโโโโโโโโโโโ โ
โ  โ  UseCases    โ   โ  Repositories  โ โ
โ  โโโโโโโโฌโโโโโโโโ   โโโโโโโโโโฌโโโโโโโโ โ
โโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโ
          โ                      โ
          โผ                      โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ            DATA LAYER                   โ
โ  โโโโโโโโโโโโโโโโ   โโโโโโโโโโโโโโโโโโ โ
โ  โ Data Sources โ   โ Repositories   โ โ
โ  โ  (Firebase)  โ   โ Implementation โ โ
โ  โโโโโโโโฌโโโโโโโโ   โโโโโโโโโโฌโโโโโโโโ โ
โโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโ
          โ                      โ
          โผ                      โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ     Firebase Cloud / Local Storage      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## 1๏ธโฃ Flujo de Autenticaciรณn

### Login de Usuario

```
โโโโโโโโโโโโโโโโ
โ  LoginPage   โ
โ (UI Input)   โ
โโโโโโโโฌโโโโโโโโ
       โ AuthLoginRequested(email, password)
       โผ
โโโโโโโโโโโโโโโโ
โ  AuthBloc    โ
โ              โ
โโโโโโโโฌโโโโโโโโ
       โ execute()
       โผ
โโโโโโโโโโโโโโโโ
โ LoginUseCase โ
โ              โ
โโโโโโโโฌโโโโโโโโ
       โ login(email, password)
       โผ
โโโโโโโโโโโโโโโโโโโโโโโ
โ AuthRepositoryImpl  โ
โ                     โ
โโโโโโโโฌโโโโโโโโโโโโโโโ
       โ
       โโโบ FirebaseAuthDataSource.login()
       โ   โโโบ Firebase Auth API
       โ
       โโโบ AuthLocalDataSource.cacheUser()
           โโโบ SharedPreferences

       โผ
โโโโโโโโโโโโโโโโ
โ  AuthResult  โ
โ (User/Error) โ
โโโโโโโโฌโโโโโโโโ
       โ
       โผ
โโโโโโโโโโโโโโโโโโโโ
โ AuthState        โ
โ .Authenticated   โ
โ .Error           โ
โโโโโโโโฌโโโโโโโโโโโโ
       โ
       โผ
โโโโโโโโโโโโโโโโ
โ UI Update    โ
โ Navigate โ   โ
โ Dashboard    โ
โโโโโโโโโโโโโโโโ
```

**Pasos:**
1. Usuario ingresa email/password en LoginPage
2. LoginPage dispara evento `AuthLoginRequested` al AuthBloc
3. AuthBloc ejecuta LoginUseCase
4. LoginUseCase llama a AuthRepository.login()
5. AuthRepositoryImpl:
   - Llama a FirebaseAuthDataSource para autenticar
   - Si es exitoso, guarda en cache con AuthLocalDataSource
6. Retorna AuthResult
7. AuthBloc emite nuevo estado:
   - `AuthAuthenticated` si OK โ navega a Dashboard
   - `AuthError` si falla โ muestra mensaje de error

---

## 2๏ธโฃ Flujo de Monitoreo del Dashboard

### Inicio de Monitoreo

```
โโโโโโโโโโโโโโโโโโโโ
โ ControlPanel     โ
โ (Play Button)    โ
โโโโโโโโโโฌโโโโโโโโโโ
         โ DashboardStartMonitoring
         โผ
โโโโโโโโโโโโโโโโโโโโ
โ DashboardBloc    โ
โ                  โ
โโโโโโโโโโฌโโโโโโโโโโ
         โ startSimulation()
         โผ
โโโโโโโโโโโโโโโโโโโโ
โ SensorSimulator  โ
โ (Core/Mocks)     โ
โโโโโโโโโโฌโโโโโโโโโโ
         โ Stream<SensorData>
         โ cada 100ms
         โผ
โโโโโโโโโโโโโโโโโโโโ
โ DashboardBloc    โ
โ _onSensorData()  โ
โโโโโโโโโโฌโโโโโโโโโโ
         โ
         โโโบ RiskCalculator.calculateRiskScore()
         โ   โโโบ Analiza aceleraciรณn, giro, historial
         โ
         โโโบ Detecta patrones peligrosos:
         โ   โโโบ isRecklessDriving?
         โ   โโโบ isCrashDetected?
         โ   โโโบ isDistracted?
         โ
         โโโบ NotificationService.showAlert()
             โโโบ Audio + Vibraciรณn + Overlay

         โผ
โโโโโโโโโโโโโโโโโโโโ
โ DashboardState   โ
โ (Updated)        โ
โโโโโโโโโโฌโโโโโโโโโโ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ UI Widgets                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ โข RiskIndicator โ muestra score  โ
โ โข StatusIndicator โ animaciรณn    โ
โ โข StatsCards โ contadores        โ
โ โข ControlPanel โ cronรณmetro      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

**Pasos:**
1. Usuario presiona botรณn "Iniciar" en ControlPanel
2. ControlPanel dispara `DashboardStartMonitoring`
3. DashboardBloc:
   - Cambia estado a `isMonitoring = true`
   - Inicia SensorSimulator
4. SensorSimulator genera stream de SensorData cada 100ms
5. DashboardBloc recibe cada SensorData:
   - Calcula riskScore con RiskCalculator
   - Detecta patrones peligrosos
   - Si hay peligro โ dispara NotificationService
   - Actualiza estado con nuevos datos
6. UI se reconstruye automรกticamente mostrando:
   - Score de riesgo actualizado
   - Animaciones de alerta
   - Contadores incrementados
   - Cronรณmetro en progreso

---

## 3๏ธโฃ Flujo de Alertas

### Detecciรณn y Respuesta

```
โโโโโโโโโโโโโโโโโโโโ
โ  SensorData      โ
โ (accel > 3.0)    โ
โโโโโโโโโโฌโโโโโโโโโโ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโโ
โ Pattern Detectionโ
โ isRecklessDrivingโ
โ = true           โ
โโโโโโโโโโฌโโโโโโโโโโ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโโ
โ DashboardBloc    โ
โ _triggerAlert()  โ
โโโโโโโโโโฌโโโโโโโโโโ
         โ DashboardTriggerAlert
         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ NotificationService      โ
โ showAlert(type, severity)โ
โโโโโโโโโโฌโโโโโโโโโโโโโโโโโโ
         โ
         โโโบ _playAlertSound()
         โ   โโโบ audioplayers
         โ       โโโบ Tono base (medium/high/critical)
         โ       โโโบ Mensaje de voz
         โ           ("Atenciรณn, conducciรณn temeraria")
         โ
         โโโบ _triggerVibration()
         โ   โโโบ vibration plugin
         โ       โโโบ Patrรณn segรบn severidad
         โ
         โโโบ onShowOverlay()
             โโโบ AlertOverlay widget
                 โโโบ Dialog visual en pantalla

         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ DashboardState           โ
โ โข currentAlertType โ    โ
โ โข recentAlerts.add() โ  โ
โ โข recklessCount++ โ     โ
โโโโโโโโโโฌโโโโโโโโโโโโโโโโโโ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ UI Response              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ โข StatusIndicator pulsa  โ
โ โข StatsCards actualiza   โ
โ โข RiskScore aumenta      โ
โ โข AlertOverlay aparece   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

**Clasificaciรณn de Alertas:**
- **Distracciรณn**: Uso de celular, mirada fuera del camino
- **Temeraria**: Aceleraciรณn > 3.0 m/sยฒ, giros > 45ยฐ/s
- **Emergencia**: Aceleraciรณn > 15.0 m/sยฒ (posible impacto)

**Severidades:**
- **Low**: Eventos menores
- **Medium**: Distracciones, frenadas bruscas
- **High**: Conducciรณn temeraria
- **Critical**: Impactos, emergencias

---

## 4๏ธโฃ Flujo de Sesiones de Conducciรณn

### Inicio de Sesiรณn

```
โโโโโโโโโโโโโโโโโโโโ
โ DashboardPage    โ
โ (Start Session)  โ
โโโโโโโโโโฌโโโโโโโโโโ
         โ SessionStartRequested
         โผ
โโโโโโโโโโโโโโโโโโโโ
โ SessionBloc      โ
โ                  โ
โโโโโโโโโโฌโโโโโโโโโโ
         โ execute()
         โผ
โโโโโโโโโโโโโโโโโโโโ
โ StartSessionUC   โ
โ                  โ
โโโโโโโโโโฌโโโโโโโโโโ
         โ
         โโโบ Geolocator.getCurrentPosition()
         โ   โโโบ Captura ubicaciรณn GPS
         โ
         โโโบ SessionRepository.startSession()
             โโโบ SessionRepositoryImpl
                 โโโบ Firestore.collection('driving_sessions')
                     .add({
                       userId: uid,
                       startLocation: GeoPoint,
                       startTime: Timestamp,
                       status: 'active'
                     })

         โผ
โโโโโโโโโโโโโโโโโโโโ
โ DrivingSession   โ
โ (Entity)         โ
โโโโโโโโโโฌโโโโโโโโโโ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโโ
โ SessionState     โ
โ .Active          โ
โโโโโโโโโโฌโโโโโโโโโโ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโโ
โ UI Update        โ
โ Session ID: xyz  โ
โโโโโโโโโโโโโโโโโโโโ
```

### Registro de Evento

```
โโโโโโโโโโโโโโโโโโโโ
โ DashboardBloc    โ
โ (Alert Triggered)โ
โโโโโโโโโโฌโโโโโโโโโโ
         โ SessionAddEvent
         โผ
โโโโโโโโโโโโโโโโโโโโ
โ SessionBloc      โ
โ                  โ
โโโโโโโโโโฌโโโโโโโโโโ
         โ execute()
         โผ
โโโโโโโโโโโโโโโโโโโโ
โ AddSessionEventUCโ
โ                  โ
โโโโโโโโโโฌโโโโโโโโโโ
         โ addEvent(sessionId, event)
         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ SessionRepository        โ
โ addEventToSession()      โ
โโโโโโโโโโฌโโโโโโโโโโโโโโโโโโ
         โ
         โโโบ Firestore
             .collection('session_events')
             .add({
               sessionId: xyz,
               eventType: 'reckless_driving',
               severity: 'high',
               timestamp: now,
               sensorData: {...}
             })

         โผ
โโโโโโโโโโโโโโโโโโโโ
โ SessionState     โ
โ events.add()     โ
โโโโโโโโโโโโโโโโโโโโ
```

### Fin de Sesiรณn

```
โโโโโโโโโโโโโโโโโโโโ
โ DashboardPage    โ
โ (Stop Session)   โ
โโโโโโโโโโฌโโโโโโโโโโ
         โ SessionEndRequested
         โผ
โโโโโโโโโโโโโโโโโโโโ
โ SessionBloc      โ
โ                  โ
โโโโโโโโโโฌโโโโโโโโโโ
         โ execute()
         โผ
โโโโโโโโโโโโโโโโโโโโ
โ EndSessionUC     โ
โ                  โ
โโโโโโโโโโฌโโโโโโโโโโ
         โ
         โโโบ Geolocator.getCurrentPosition()
         โ   โโโบ Captura ubicaciรณn final
         โ
         โโโบ Calcula estadรญsticas:
         โ   โโโบ Duraciรณn total
         โ   โโโบ Total de eventos
         โ   โโโบ Score promedio
         โ   โโโบ Clasificaciรณn por tipo
         โ
         โโโบ SessionRepository.endSession()
             โโโบ Firestore.doc(sessionId).update({
                   endLocation: GeoPoint,
                   endTime: Timestamp,
                   duration: seconds,
                   totalEvents: count,
                   riskScore: avg,
                   status: 'completed'
                 })

         โผ
โโโโโโโโโโโโโโโโโโโโ
โ SessionState     โ
โ .Ended           โ
โโโโโโโโโโฌโโโโโโโโโโ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโโ
โ Navigate โ       โ
โ HistoryPage      โ
โโโโโโโโโโโโโโโโโโโโ
```

---

## 5๏ธโฃ Flujo de Integraciรณn ESP32-CAM

### Recepciรณn de Frames

```
โโโโโโโโโโโโโโโโโโโโ
โ   ESP32-CAM      โ
โ (Capture Image)  โ
โโโโโโโโโโฌโโโโโโโโโโ
         โ HTTP POST /upload
         โ Body: {"image": "<base64>", "timestamp": 12345}
         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ HttpServerService        โ
โ (Shelf Router)           โ
โโโโโโโโโโฌโโโโโโโโโโโโโโโโโโ
         โ
         โโโบ Validar JSON
         โโโบ Decodificar Base64
         โโโบ Verificar JPEG magic bytes
         โโโบ Validar tamaรฑo (<500KB)
         โ
         โโโบ Si vรกlido:
             โโโบ Crear CameraFrame
             โโโบ Agregar a Stream

         โผ
โโโโโโโโโโโโโโโโโโโโ
โ CameraRepository โ
โ frameStream      โ
โโโโโโโโโโฌโโโโโโโโโโ
         โ Stream<CameraFrame>
         โผ
โโโโโโโโโโโโโโโโโโโโ
โ CameraStreamBloc โ
โ _onNewFrame()    โ
โโโโโโโโโโฌโโโโโโโโโโ
         โ CameraStreamNewFrame
         โผ
โโโโโโโโโโโโโโโโโโโโ
โ CameraStreamStateโ
โ .NewFrame        โ
โ (frame, count)   โ
โโโโโโโโโโฌโโโโโโโโโโ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ESP32DebugPanel          โ
โ (Widget)                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ โข Image.memory(bytes) โ โ
โ โข Timestamp โ           โ
โ โข Counter โ             โ
โ โข Fade Animation โ      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

**Respuesta al ESP32:**
```json
HTTP 200 OK
{
  "status": "success",
  "receivedAt": "2025-10-17T14:23:45.123Z",
  "frameNumber": 127
}
```

---

## 6๏ธโฃ Flujo de Cรกlculo de Riesgo

### Algoritmo de RiskCalculator

```
โโโโโโโโโโโโโโโโโโโโ
โ  SensorData      โ
โ (Entrada)        โ
โโโโโโโโโโฌโโโโโโโโโโ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ RiskCalculator             โ
โ calculateRiskScore()       โ
โโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโ
         โ
         โโโบ Factor Aceleraciรณn (30%)
         โ   โโโบ magnitude = sqrt(xยฒ + yยฒ + zยฒ)
         โ       โโโบ score += min(magnitude * 10, 30)
         โ
         โโโบ Factor Rotaciรณn (30%)
         โ   โโโบ magnitude = sqrt(gxยฒ + gyยฒ + gzยฒ)
         โ       โโโบ score += min(magnitude / 2, 30)
         โ
         โโโบ Factor Historial (40%)
             โโโบ recentAlerts.length * 5
                 โโโบ score += min(count * 5, 40)

         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ Risk Score (0-100)         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ 0-30:  Verde (Seguro)      โ
โ 30-60: Naranja (Moderado)  โ
โ 60-100: Rojo (Peligroso)   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

**Ejemplo de Cรกlculo:**

Entrada:
- Aceleraciรณn: (2.5, 1.2, 10.3) m/sยฒ
- Giroscopio: (15, 8, 20) ยฐ/s
- Alertas recientes: 3

Cรกlculo:
1. Aceleraciรณn:
   - Magnitud = sqrt(2.5ยฒ + 1.2ยฒ + (10.3-9.8)ยฒ) = 2.8
   - Score = min(2.8 * 10, 30) = **28**

2. Rotaciรณn:
   - Magnitud = sqrt(15ยฒ + 8ยฒ + 20ยฒ) = 26.3
   - Score = min(26.3 / 2, 30) = **13.15**

3. Historial:
   - Score = min(3 * 5, 40) = **15**

**Risk Score Total = 28 + 13.15 + 15 = 56.15 (Moderado)**

---

## 7๏ธโฃ Flujo de Datos de Firebase

### Estructura de Firestore

```
firestore/
โโโ users/
โ   โโโ {userId}/
โ       โโโ email: string
โ       โโโ displayName: string
โ       โโโ createdAt: Timestamp
โ       โโโ lastLogin: Timestamp
โ
โโโ driving_sessions/
โ   โโโ {sessionId}/
โ       โโโ userId: string
โ       โโโ startTime: Timestamp
โ       โโโ endTime: Timestamp?
โ       โโโ startLocation: GeoPoint
โ       โโโ endLocation: GeoPoint?
โ       โโโ duration: number (seconds)
โ       โโโ totalEvents: number
โ       โโโ riskScore: number
โ       โโโ status: 'active' | 'completed'
โ       โโโ stats: {
โ           distractionCount: number,
โ           recklessCount: number,
โ           emergencyCount: number
โ       }
โ
โโโ session_events/
    โโโ {eventId}/
        โโโ sessionId: string
        โโโ eventType: string
        โโโ severity: string
        โโโ timestamp: Timestamp
        โโโ sensorData: {
        โ   accelerationX: number,
        โ   accelerationY: number,
        โ   accelerationZ: number,
        โ   gyroscopeX: number,
        โ   gyroscopeY: number,
        โ   gyroscopeZ: number
        โโโ }
```

### Queries Principales

**1. Obtener sesiones de un usuario:**
```dart
FirebaseFirestore.instance
  .collection('driving_sessions')
  .where('userId', isEqualTo: userId)
  .orderBy('startTime', descending: true)
  .limit(20)
  .get()
```

**2. Obtener eventos de una sesiรณn:**
```dart
FirebaseFirestore.instance
  .collection('session_events')
  .where('sessionId', isEqualTo: sessionId)
  .orderBy('timestamp')
  .get()
```

**3. Actualizar sesiรณn activa:**
```dart
FirebaseFirestore.instance
  .collection('driving_sessions')
  .doc(sessionId)
  .update({
    'endTime': FieldValue.serverTimestamp(),
    'status': 'completed',
    'totalEvents': count
  })
```

---

## 8๏ธโฃ Flujo de Notificaciones

### Sistema Multimodal

```
โโโโโโโโโโโโโโโโโโโโ
โ  Alert Trigger   โ
โ (Evento Detectadoโ
โโโโโโโโโโฌโโโโโโโโโโ
         โ showAlert(type, severity)
         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ NotificationService         โ
โ (Singleton)                 โ
โโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโ
         โ
         โโโบ Canal 1: Audio
         โ   โโโบ _playAlertSound()
         โ   โ   โโโบ audioplayers.play()
         โ   โ       โโโบ Tono base (medium/high/critical)
         โ   โ       โโโบ Mensaje de voz especรญfico
         โ   โ
         โ   โโโบ Volumen segรบn configuraciรณn
         โ
         โโโบ Canal 2: Vibraciรณn
         โ   โโโบ _triggerVibration()
         โ       โโโบ Vibration.vibrate(pattern)
         โ           โโโบ Low: 200ms
         โ           โโโบ Medium: [0,300,100,300]
         โ           โโโบ High: [0,500,200,500,200,500]
         โ           โโโบ Critical: [0,1000,300,1000,300,1000]
         โ
         โโโบ Canal 3: Visual
             โโโบ onShowOverlay()
                 โโโบ AlertOverlay.show()
                     โโโบ รcono segรบn tipo
                     โโโบ Color segรบn severidad
                     โโโบ Mensaje descriptivo
                     โโโบ Botรณn "Entendido"

         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ Cooldown Manager            โ
โ (Evita spam de alertas)     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ lastAlertTime[type] = now   โ
โ Si (now - last) < 30s:      โ
โ   return (no mostrar)       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

**Assets de Notificaciรณn:**

Audio:
- `assets/sounds/alerts/medium_alert.mp3`
- `assets/sounds/alerts/high_alert.mp3`
- `assets/sounds/alerts/critical_alert.mp3`
- `assets/sounds/voices/distraction_warning_es.mp3`
- `assets/sounds/voices/reckless_warning_es.mp3`
- `assets/sounds/voices/impact_warning_es.mp3`
- `assets/sounds/voices/phone_use_warning_es.mp3`
- `assets/sounds/voices/look_away_warning_es.mp3`
- `assets/sounds/voices/sudden_brake_warning_es.mp3`

---

## 9๏ธโฃ Flujo de Navegaciรณn

### Rutas Principales

```
/splash (Inicial)
  โ
  โโโบ Firebase Auth Check
  โ   โโโบ Autenticado โ /dashboard
  โ   โโโบ No autenticado โ /login
  โ
/login
  โ
  โโโบ Login Exitoso โ /dashboard
  โโโบ Olvidรฉ contraseรฑa โ /forgot-password
  โโโบ Crear cuenta โ /register

/dashboard (Protegida)
  โ
  โโโบ Menรบ lateral:
  โ   โโโบ Perfil โ /profile
  โ   โโโบ Historial โ /history
  โ   โโโบ Notificaciones โ /notification-settings
  โ   โโโบ ESP32 Debug โ /esp32-debug
  โ   โโโบ Cerrar sesiรณn โ /login
  โ
  โโโบ Botรณn emergencia โ Dialog modal

/history
  โ
  โโโบ Tap en sesiรณn โ /session-events?id={sessionId}

/profile
  โ
  โโโบ Editar contactos โ Dialog modal
```

**Protecciรณn de Rutas:**
```dart
redirect: (context, state) {
  final isLoggedIn = authBloc.state is AuthAuthenticated;
  final isGoingToLogin = state.location == '/login';

  if (!isLoggedIn && !isGoingToLogin) {
    return '/login'; // Redirige a login si no autenticado
  }

  if (isLoggedIn && isGoingToLogin) {
    return '/dashboard'; // Redirige a dashboard si ya autenticado
  }

  return null; // Permite navegaciรณn
}
```

---

## ๐ Flujo de Ciclo de Vida

### Inicializaciรณn de la App

```
main()
  โ
  โโโบ WidgetsFlutterBinding.ensureInitialized()
  โโโบ Firebase.initializeApp()
  โโโบ NotificationService.initialize()
  โ   โโโบ Cargar assets de audio
  โ   โโโบ Inicializar vibration
  โ   โโโบ Configurar local notifications
  โ
  โโโบ runApp(MyApp)
      โ
      โโโบ MultiBlocProvider
          โโโบ AuthBloc (singleton)
          โโโบ DashboardBloc
          โโโบ SessionBloc
          โโโบ CameraStreamBloc

          โโโบ MaterialApp.router(AppRouter.router)
              โ
              โโโบ SplashPage (inicial)
                  โ
                  โโโบ AuthCheckRequested
                      โโโบ Autenticado โ Dashboard
                      โโโบ No autenticado โ Login
```

### Cierre Limpio

```
DashboardPage.dispose()
  โ
  โโโบ SessionBloc.add(SessionEndRequested)
  โ   โโโบ Guarda sesiรณn en Firestore
  โ
  โโโบ DashboardBloc.add(DashboardStopMonitoring)
  โ   โโโบ SensorSimulator.stopSimulation()
  โ
  โโโบ CameraStreamBloc.add(CameraStreamStop)
      โโโบ HttpServerService.close()
          โโโบ Libera puerto 8080
```

---

## ๐ Mรฉtricas de Performance

### Intervalos de Actualizaciรณn

| Componente | Intervalo | Justificaciรณn |
|---|---|---|
| SensorData | 100ms | Detecciรณn rรกpida de cambios |
| UI Dashboard | 300ms | Throttling para evitar renders excesivos |
| Risk Score | 300ms | Sincronizado con UI |
| Frame ESP32 | 500ms | Balance entre latencia y bandwidth |
| Session Update | 30s | Actualizaciรณn periรณdica a Firestore |

### Optimizaciones

1. **Stream Throttling:**
   ```dart
   sensorStream
     .throttleTime(Duration(milliseconds: 300))
     .listen((data) => updateUI(data));
   ```

2. **Debouncing de Alertas:**
   - Cooldown de 30s entre alertas del mismo tipo
   - Cola mรกxima de 10 alertas

3. **Gestiรณn de Memoria:**
   - ESP32: Solo guarda รบltimo frame
   - Firebase: Queries con lรญmite de 20 registros
   - Audio: Pre-carga de assets en initState

---

## ๐ Manejo de Estados de Error

### Estrategias de Recuperaciรณn

```
Error en Firebase Auth
  โ
  โโโบ AuthError state
  โ   โโโบ Muestra mensaje al usuario
  โ       โโโบ Permite reintentar
  โ
Error en Firestore Write
  โ
  โโโบ SessionError state
  โ   โโโบ Guarda en queue local
  โ       โโโบ Reintenta en prรณxima conexiรณn
  โ
Error en HTTP Server (ESP32)
  โ
  โโโบ CameraStreamError state
  โ   โโโบ Muestra mensaje de reconexiรณn
  โ       โโโบ Botรณn manual de reinicio
  โ
Error en Sensor Simulator
  โ
  โโโบ DashboardError state
      โโโบ Detiene monitoreo
          โโโบ Botรณn de reinicio
```

---

Este documento detalla el flujo completo de datos en la aplicaciรณn DriveGuard, desde la captura de sensores hasta la presentaciรณn en UI y persistencia en Firebase.
